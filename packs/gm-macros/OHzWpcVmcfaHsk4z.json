{
  "name": "Request Roll",
  "type": "script",
  "author": "6cxUP4dSannVjU9o",
  "img": "icons/svg/d20-highlight.svg",
  "scope": "global",
  "command": "const OWNER_PERMISSION_LEVEL = 3;\n\n// Habilidades mapeadas según tus imágenes\nconst habilidades = {\n  \"agi\": \"Agilidad\",\n  \"ath\": \"Atletismo\",\n  \"hwp\": \"Armas Pesadas\",\n  \"lwp\": \"Armas Ligeras\",\n  \"stl\": \"Sigilo\",\n  \"thv\": \"Hurto/Thievery\",\n  \"cra\": \"Artesanía/Crafting/Manufactura\",\n  \"ded\": \"Deducción\",\n  \"dis\": \"Disciplina\",\n  \"inm\": \"Intimidación\",\n  \"lor\": \"Saber\",\n  \"med\": \"Medicina\",\n  \"dec\": \"Engaño\",\n  \"ins\": \"Perspicacia\",\n  \"lea\": \"Liderazgo\",\n  \"prc\": \"Percepción\",\n  \"prs\": \"Persuasión\",\n  \"sur\": \"Supervivencia\"\n};\n\n// --- DEBUG OPCIONAL ---\n// Descomenta si quieres ver debug en el chat del GM\n/*\nfunction debug(msg) {\n  ChatMessage.create({\n    content: `<b>[DEBUG]</b> ${msg}`,\n    whisper: [game.user.id]\n  });\n}\n*/\n\n// Paso 1: elegir actor\nlet actoresConDueñoArr = game.actors.filter(a => a.hasPlayerOwner);\nif(actoresConDueñoArr.length === 0) {\n  ui.notifications.warn(\"No hay personajes controlados por jugadores en la partida.\");\n  return;\n}\n\nlet actoresOptions = actoresConDueñoArr.map(a => `<option value=\"${a.id}\">${a.name}</option>`).join(\"\");\n\n// Paso 2: mostrar diálogo inicial para seleccionar actor\nnew Dialog({\n  title: \"Selecciona personaje\",\n  content: `<p><b>Selecciona el personaje:</b></p>\n            <select id=\"actor\">${actoresOptions}</select>`,\n  buttons: {\n    siguiente: {\n      label: \"Siguiente\",\n      callback: async html => {\n        const actorId = html.find(\"#actor\").val();\n        const actor = game.actors.get(actorId);\n        if (!actor) return ui.notifications.error(\"Actor no encontrado\");\n\n        // Generar opciones SOLO con las habilidades listadas\n        let habilidadesOptions = Object.entries(habilidades)\n          .map(([key, nombre]) => `<option value=\"${key}\">${nombre}</option>`)\n          .join(\"\");\n\n        // Paso 3: mostrar diálogo de habilidades\n        new Dialog({\n          title: `Solicitar tirada: ${actor.name}`,\n          content: `<p><b>Selecciona la habilidad:</b></p>\n                    <select id=\"habilidad\">${habilidadesOptions}</select>`,\n          buttons: {\n            enviar: {\n              label: \"Enviar Solicitud\",\n              callback: async html2 => {\n                const habilidad = html2.find(\"#habilidad\").val();\n\n                // Buscar jugador con permiso OWNER\n                let player = game.users.players.find(u => actor.testUserPermission(u, OWNER_PERMISSION_LEVEL));\n                if (!player) return ui.notifications.error(\"No se encontró jugador que controle este personaje.\");\n\n                // Mensaje privado con botón\n                const chatContent = `\n                  <p><b>${game.user.name}</b> te solicita una tirada de <b>${habilidades[habilidad]}</b> para <b>${actor.name}</b>.</p>\n                  <button class=\"roll-solicitud\" data-actor-id=\"${actor.id}\" data-skill=\"${habilidad}\">🎲 Lanzar Tirada</button>\n                `;\n\n                await ChatMessage.create({\n                  user: player.id,\n                  whisper: [player.id],\n                  speaker: { alias: \"Solicitud de Tirada\" },\n                  content: chatContent\n                });\n\n                ui.notifications.info(`Solicitud enviada a ${player.name}`);\n              }\n            }\n          }\n        }).render(true);\n      }\n    }\n  }\n}).render(true);",
  "folder": null,
  "sort": 0,
  "ownership": {
    "default": 0
  },
  "flags": {
    "exportSource": {
      "world": "vinculosyjur-69b5b203",
      "system": "cosmere-rpg",
      "coreVersion": "12.343",
      "systemVersion": "1.0.1"
    }
  },
  "_id": "OHzWpcVmcfaHsk4z"
}